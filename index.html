<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking de Estudiantes - Saber 11</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'brand-primary': '#F97316',
                        'brand-secondary': '#3B82F6',
                        'brand-text': '#374151',
                        'brand-bg': '#F9FAFB', 
                        'brand-header': '#1F2937',
                        'brand-red': '#EF4444',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --color-lectura-start: #0ea5e9; --color-lectura-end: #3b82f6;
            --color-matematicas-start: #ef4444; --color-matematicas-end: #dc2626;
            --color-sociales-start: #f59e0b; --color-sociales-end: #eab308;
            --color-ciencias-start: #22c55e; --color-ciencias-end: #16a34a;
            --color-ingles-start: #a855f7; --color-ingles-end: #9333ea;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--brand-bg);
            color: var(--brand-text);
            overflow-x: hidden;
        }
        body.overflow-hidden { overflow: hidden; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in-up { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes slideInRight { from { opacity: 0; transform: translateX(30px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes slideOutLeft { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(-30px); } }

        #ranking-view, #report-view { transition: opacity 0.4s ease, transform 0.4s ease; }
        #ranking-view.leaving { animation: slideOutLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        #report-view.entering { animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        #report-view.leaving { animation: slideOutLeft 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        #ranking-view.entering { animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        /* --- Estilos Informe Virtual Reimaginados --- */
        .report-card {
            background-color: white;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin-bottom: 2rem;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }
        .report-card-header {
            color: white;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        @media (min-width: 640px) {
            .report-card-header {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
            }
        }
        
        .report-card-body { padding: 1.5rem; }
        
        .performance-bar-container {
            position: relative;
            padding-top: 2.5rem;
            margin-top: 1rem;
        }

        .performance-level-bar {
            display: flex;
            height: 1rem;
            border-radius: 9999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.08);
        }
        .level-segment {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .level-segment:hover {
            transform: scaleY(1.2);
            filter: brightness(1.1);
        }
        .level-segment[data-level='1'] { background-color: #fca5a5; } /* red-300 */
        .level-segment[data-level='2'] { background-color: #fdba74; } /* orange-300 */
        .level-segment[data-level='3'] { background-color: #bef264; } /* lime-300 */
        .level-segment[data-level='4'] { background-color: #86efac; } /* green-300 */
        .level-segment[data-level='A-'], .level-segment[data-level='A1'] { background-color: #fca5a5; }
        .level-segment[data-level='A2'] { background-color: #fdba74; }
        .level-segment[data-level='B1'] { background-color: #bef264; }
        .level-segment[data-level='B+'] { background-color: #86efac; }

        .your-level-pointer {
            position: absolute;
            top: 0;
            transform: translateX(-50%);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 10;
        }
        .pointer-box {
            background-color: #3B82F6;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            white-space: nowrap;
        }
        .pointer-arrow {
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid #3B82F6;
            margin: 0 auto;
        }
        
        .skills-container {
            max-height: 0;
            overflow: hidden;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            margin-top: 0;
        }
        .skills-container.expanded {
            max-height: 1000px;
            opacity: 1;
            margin-top: 1.5rem;
        }
        .toggle-skills-btn svg { transition: transform 0.3s ease; }
        .toggle-skills-btn.expanded svg { transform: rotate(180deg); }

        /* --- Mejoras de Responsividad General --- */
        .podium-card-wrapper { 
            border-radius: 1.25rem; 
            transition: all 0.3s ease; 
            position: relative;
            width: 100%;
            max-width: 320px;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -2px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
        }
        .podium-card-wrapper:hover { 
            transform: translateY(-10px) scale(1.03); 
            box-shadow: 0 25px 50px -12px rgb(0 0 0 / 0.15);
        }

        .general-stats-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }

        .ranking-section-card {
             background-color: white;
             border-radius: 1rem;
             box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05), 0 2px 4px -1px rgba(0,0,0,0.06);
             border: 1px solid #e5e7eb;
             padding: 1.5rem;
        }
        
        #mobile-ranking-list .bg-white {
             border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-brand-bg text-brand-text">

    <div id="app-container" class="main-container mx-auto p-4 sm:p-6 lg:p-8">
        
        <div id="ranking-view">
            <header class="text-center mb-8 md:mb-12 fade-in-up">
                <h1 class="text-3xl sm:text-5xl font-extrabold text-brand-header tracking-tight">Ranking de Resultados Saber 11</h1>
                <p class="mt-3 text-lg text-gray-500 max-w-3xl mx-auto">Explora, compara y analiza de forma interactiva los resultados de nuestros estudiantes.</p>
            </header>

            <main class="space-y-8 md:space-y-12">
                
                <section style="animation-delay: 100ms;" class="fade-in-up">
                    <h2 class="text-3xl font-bold text-center mb-8 text-brand-header">Podio de Honor</h2>
                    <div id="top-performers" class="flex flex-col md:flex-row justify-center items-center md:items-end gap-4 md:gap-2 pt-5 md:pt-10">
                        <!-- Podium content will be generated by JS -->
                    </div>
                </section>
                
                <section style="animation-delay: 200ms;" class="fade-in-up grid md:grid-cols-2 gap-6 my-8">
                    <div class="bg-gradient-to-r from-brand-primary to-orange-500 text-white p-6 rounded-xl shadow-lg text-center flex flex-col items-center justify-center">
                        <h3 class="text-2xl font-bold">¿Quieres Ser el Próximo Genio?</h3>
                        <p class="mt-2 max-w-sm">Nuestro Pre-Icfes te da las herramientas para alcanzar la excelencia. ¡Inscripciones abiertas!</p>
                        <button class="mt-4 bg-white text-brand-primary font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition-transform transform hover:scale-105">Ver Planes</button>
                    </div>
                    <div class="bg-gradient-to-r from-brand-secondary to-blue-500 text-white p-6 rounded-xl shadow-lg text-center flex flex-col items-center justify-center">
                        <h3 class="text-2xl font-bold">¿Quieres aparecer en este Ranking?</h3>
                        <p class="mt-2 max-w-sm">Inscribe tus resultados del ICFES Saber 11 y compite para ser el mejor.</p>
                        <a href="https://docs.google.com/forms/d/1-oOUf_1Al53G-nKgstr3UZh2heAkwAzap5pb77Y-vRI/edit#responses" target="_blank" class="mt-4 inline-block bg-white text-brand-secondary font-bold py-2 px-6 rounded-full hover:bg-gray-200 transition-transform transform hover:scale-105">Inscribirme Ahora</a>
                    </div>
                </section>
                
                <section style="animation-delay: 300ms;" class="fade-in-up">
                    <h2 class="text-3xl font-bold text-center mb-8 text-brand-header">Estadísticas del Grupo</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6">
                        <div class="general-stats-card">
                            <p class="text-sm font-semibold text-gray-500">Puntaje Máximo</p>
                            <p id="max-score" class="text-4xl sm:text-5xl font-bold text-brand-secondary mt-2">0</p>
                        </div>
                        <div class="general-stats-card">
                            <p class="text-sm font-semibold text-gray-500">Puntajes > 350</p>
                            <p id="high-scorers-count" class="text-4xl sm:text-5xl font-bold text-brand-primary mt-2">0</p>
                        </div>
                        <div class="general-stats-card">
                            <p class="text-sm font-semibold text-gray-500">Puntaje Mínimo</p>
                            <p id="min-score" class="text-4xl sm:text-5xl font-bold text-brand-red mt-2">0</p>
                        </div>
                    </div>
                </section>

                <section style="animation-delay: 400ms;" class="fade-in-up ranking-section-card">
                    <h3 class="text-xl font-bold text-center mb-4 text-brand-header">Promedios por Área</h3>
                    <div id="subject-averages-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">
                        <!-- Generated dynamically -->
                    </div>
                </section>

                <section style="animation-delay: 500ms;" class="fade-in-up ranking-section-card">
                     <div class="flex flex-col md:flex-row justify-between items-center gap-4 mb-6">
                         <div class="text-center md:text-left">
                             <h2 class="text-2xl font-bold text-brand-header">Ranking General</h2>
                             <p id="ranking-subtitle" class="text-sm text-gray-500 mt-1">Ordenado por Puntaje Global</p>
                         </div>
                        <div class="flex flex-col sm:flex-row items-stretch gap-4">
                             <div class="bg-gray-50 p-4 rounded-lg flex flex-col justify-center items-center text-center border">
                                  <p class="text-sm font-semibold text-gray-500">Total Estudiantes</p>
                                  <p id="total-students" class="text-3xl font-bold text-brand-secondary">0</p>
                             </div>
                             <div class="bg-gray-50 p-4 rounded-lg flex flex-col justify-center items-center text-center border">
                                 <p class="text-sm font-semibold text-gray-500">Promedio</p>
                                 <p id="average-score" class="text-3xl font-bold text-brand-primary">0</p>
                             </div>
                              <div class="bg-gray-50 p-4 rounded-lg flex flex-col justify-center items-center text-center border">
                                 <p class="text-sm font-semibold text-gray-500">Mediana</p>
                                 <p id="median-score" class="text-3xl font-bold text-green-600">0</p>
                              </div>
                        </div>
                     </div>

                    <div class="my-8">
                        <div class="md:hidden mb-4 space-y-4">
                            <button id="open-filter-menu-btn" class="w-full bg-brand-primary text-white font-bold py-2 px-6 rounded-lg inline-flex items-center justify-center gap-2 shadow-md hover:bg-orange-600 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>
                                Menú de Filtros
                            </button>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                     <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                </div>
                                <input type="text" id="searchInputMobile" placeholder="Buscar por nombre o municipio..." class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                <button id="clearSearchBtnMobile" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                                     <svg class="h-5 w-5 text-gray-500 hover:text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                </button>
                            </div>
                        </div>

                        <div id="desktop-filters" class="hidden md:flex bg-gray-50 p-4 rounded-xl border flex-col md:flex-row items-center gap-4 md:gap-6">
                            <div class="w-full md:flex-1">
                                <div class="relative">
                                     <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                         <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" /></svg>
                                     </div>
                                     <input type="text" id="searchInput" placeholder="Buscar por nombre o municipio..." class="w-full pl-10 pr-10 py-2 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-brand-primary">
                                     <button id="clearSearchBtn" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                                         <svg class="h-5 w-5 text-gray-500 hover:text-gray-700" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>
                                     </button>
                                </div>
                            </div>

                            <div class="flex items-center gap-2">
                                 <span class="text-sm font-medium text-gray-600">Ordenar por:</span>
                                 <div class="relative w-full md:w-auto">
                                    <button id="sort-dropdown-btn" class="w-full md:w-56 bg-white border border-gray-300 text-gray-700 font-semibold rounded-full py-2 px-4 text-left flex justify-between items-center transition-shadow hover:shadow-md">
                                         <span id="sort-dropdown-label" class="truncate">Puntaje Global</span>
                                         <svg class="h-5 w-5 transform transition-transform text-gray-400" id="sort-dropdown-arrow" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                                    </button>
                                     <div id="sort-dropdown-options" class="hidden absolute right-0 mt-2 w-full bg-white rounded-lg shadow-xl z-20 border">
                                         <!-- Opciones generadas por JS -->
                                     </div>
                                 </div>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto md:block hidden">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 uppercase text-xs">
                                <tr>
                                    <th class="p-4 w-16 text-center">#</th>
                                    <th class="p-4 w-2/5 text-left">Nombre Completo</th>
                                    <th class="p-4 w-1/5 text-center">Puntaje Global</th>
                                    <th id="area-score-header" class="p-4 w-1/5 text-center area-score-col">Puntaje de Área</th>
                                    <th class="p-4 w-1/5 text-left">Municipio</th>
                                    <th class="p-4 w-28 text-center">Detalles</th>
                                </tr>
                            </thead>
                            <tbody id="ranking-table-body" class="divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                    <div id="mobile-ranking-list" class="space-y-3 md:hidden"></div>

                    <div id="pagination-controls" class="pt-4 flex items-center justify-center gap-2 flex-wrap">
                        <!-- Generado dinámicamente -->
                    </div>
                </section>
                 <footer class="text-center mt-12 text-gray-500"><p>&copy; 2025 SeamosGenios. Todos los derechos reservados.</p></footer>
            </main>
        </div>

        <div id="report-view" class="hidden">
            <!-- El contenido se generará dinámicamente -->
        </div>
    </div>
    
    <div id="filter-menu-panel" class="fixed inset-0 bg-black bg-opacity-50 hidden z-40">
        <!-- Contenido del panel de filtros -->
    </div>

    <div id="student-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 overflow-y-auto hidden z-50">
        <!-- Contenido del modal de detalles -->
    </div>

    <script>
    const skillsData = {
        "lectura": {
            level: 4,
            categories: {
                "Análisis Crítico y Argumentación": ["Evalúa contenidos, estrategias discursivas y argumentativas presentes en un texto.","Selecciona elementos locales y construye argumentos que sustentan una tesis con base en textos relacionados.","Asume una postura crítica frente a los planteamientos de un texto."],
                "Interpretación y Relación de Textos": ["Propone soluciones a problemas de interpretación que subyacen en un texto.","Relaciona información de dos o más textos o fragmentos de texto para llegar a una conclusión.","Reconoce los contextos como elementos importantes en la valoración de un texto.","Plantea hipótesis de lectura a partir de las ideas presentes en un texto."],
                "Aplicación de Conceptos Literarios": ["Aplica conceptos de análisis literario para caracterizar diferentes elementos en un texto."]
            }
        },
        "matematicas": {
            level: 4,
            categories: {
                "Estadística, Probabilidad y Toma de Decisiones": ["Resuelve problemas que requieren interpretar información de eventos dependientes.","Reconoce en diferentes formatos el espacio muestral de un experimento aleatorio.","Resuelve problemas de conteo que requieren el uso de permutaciones.","Justifica si hay falta de información en una situación problema para tomar una decisión.","Toma decisiones sobre la veracidad o falsedad de una afirmación cuando requiere el uso de varias propiedades o conceptualizaciones formales."],
                "Análisis Algebraico y Aritmético": ["Realiza transformaciones de subconjuntos de información que pueden requerir el uso de operaciones complejas (cálculos de porcentajes).","Manipula expresiones algebraicas o aritméticas haciendo uso de las propiedades de las operaciones."],
                "Resolución de Problemas y Modelado": ["Resuelve problemas que requieren construir una representación auxiliar (gráficas y fórmulas) como paso intermedio para su solución.","Modela usando lenguaje algebraico información dada en lenguaje natural, tablas o representaciones geométricas.","Modela fenómenos variacionales no explícitos haciendo uso de lenguaje simbólico o gráficas."]
            }
        },
        "sociales": {
            level: 4,
            categories: {
                "Conocimiento Constitucional y Cívico": ["Conoce los procedimientos de reforma a la Constitución Política de Colombia, los mecanismos de participación ciudadana y las funciones de los organismos de control."],
                "Análisis de Contextos y Argumentos": ["Compara enunciados o argumentos, así como intereses y posiciones de actores en contextos en los que se discuten situaciones problemáticas o sus alternativas de solución.","Analiza fuentes (primarias y secundarias) para valorar inferencias o identificar intenciones, características de los actores involucrados y contextos en los que se ubican dichas fuentes."],
                "Pensamiento Social y Multidimensional": ["Relaciona propuestas de solución a un problema con su contexto de implementación, o con sus posibles impactos en ciertas dimensiones (económicas, políticas, culturales, ambientales, etc.).","Entiende problemáticas, eventos o procesos sociales a partir del uso de conceptos básicos de las ciencias sociales o a partir de contextos históricos y/o geográficos.","Establece relaciones entre modelos conceptuales y fuentes que los abordan o decisiones sociales que los aplican."]
            }
        },
        "ciencias": {
            level: 4,
            categories: {
                "Investigación y Comunicación Científica": ["Plantea preguntas de investigación desde las ciencias naturales a partir de un contexto determinado.","Establece conclusiones derivadas de una investigación.","Comunica resultados de procesos de investigación científica.","Analiza fenómenos naturales con base en los procedimientos propios de la investigación científica."],
                "Análisis y Aplicación de Conceptos": ["Contrasta modelos de las ciencias naturales con fenómenos cotidianos.","Resuelve situaciones problema haciendo uso de conceptos, leyes y teorías de las ciencias naturales."]
            }
        },
        "ingles": {
            level: 'B+',
            categories: { "Habilidades Superiores": ["El estudiante promedio clasificado en este nivel supera las preguntas de mayor complejidad de la prueba."] }
        }
    };
    
    document.addEventListener('DOMContentLoaded', () => {
        let studentData = [];
        let scatterChartInstance = null;
        let state = { currentSort: { key: 'globalRank', direction: 'asc' }, filteredData: [], currentPage: 1, rowsPerPage: 10, };
        
        const elements = {
            body: document.body, appContainer: document.getElementById('app-container'), rankingView: document.getElementById('ranking-view'), reportView: document.getElementById('report-view'),
            tableBody: document.getElementById('ranking-table-body'), mobileList: document.getElementById('mobile-ranking-list'), searchInput: document.getElementById('searchInput'),
            searchInputMobile: document.getElementById('searchInputMobile'), clearSearchBtn: document.getElementById('clearSearchBtn'), clearSearchBtnMobile: document.getElementById('clearSearchBtnMobile'),
            averageScoreEl: document.getElementById('average-score'), medianScoreEl: document.getElementById('median-score'), totalStudentsEl: document.getElementById('total-students'),
            maxScoreEl: document.getElementById('max-score'), minScoreEl: document.getElementById('min-score'), highScorersCount: document.getElementById('high-scorers-count'),
            subjectAveragesContainer: document.getElementById('subject-averages-container'), topPerformersContainer: document.getElementById('top-performers'),
            studentModal: document.getElementById('student-modal'), paginationControls: document.getElementById('pagination-controls'),
            subjectFilterButtonsPanel: document.getElementById('subject-filter-buttons-panel'), rankingSubtitle: document.getElementById('ranking-subtitle'), areaScoreHeader: document.getElementById('area-score-header'),
            openFilterMenuBtn: document.getElementById('open-filter-menu-btn'), closeFilterMenuBtn: document.getElementById('close-filter-menu-btn'), filterMenuPanel: document.getElementById('filter-menu-panel'),
            sortDropdownBtn: document.getElementById('sort-dropdown-btn'), sortDropdownLabel: document.getElementById('sort-dropdown-label'), sortDropdownArrow: document.getElementById('sort-dropdown-arrow'),
            sortDropdownOptions: document.getElementById('sort-dropdown-options'), scatterPlotCanvas: document.getElementById('scatter-plot-chart'),
        };

        const filterOptions = [
            { key: 'puntajeGlobal', label: 'Puntaje Global', subjectKey: 'global' },
            { key: 'puntajesDetallados.lectura', label: 'Lectura Crítica', colorVar: 'var(--color-lectura-end)', subjectKey: 'lectura' },
            { key: 'puntajesDetallados.matematicas', label: 'Matemáticas', colorVar: 'var(--color-matematicas-end)', subjectKey: 'matematicas' },
            { key: 'puntajesDetallados.sociales', label: 'Sociales', colorVar: 'var(--color-sociales-end)', subjectKey: 'sociales' },
            { key: 'puntajesDetallados.ciencias', label: 'Ciencias', colorVar: 'var(--color-ciencias-end)', subjectKey: 'ciencias' },
            { key: 'puntajesDetallados.ingles', label: 'Inglés', colorVar: 'var(--color-ingles-end)', subjectKey: 'ingles' },
        ];
        
        function loadInitialData() {
            const csvFilePath = 'BD - Hoja 1.csv';
            Papa.parse(csvFilePath, {
                download: true, header: true, skipEmptyLines: true,
                complete: (results) => {
                    console.log("Datos CSV cargados:", results.data); // DEBUG
                    if (!results.data || results.data.length === 0) {
                        alert("No se encontraron datos en el archivo CSV o el archivo no se pudo cargar. Asegúrate de que 'BD - Hoja 1.csv' esté en la misma carpeta que este archivo HTML y que no esté vacío.");
                        return;
                    }
                    processCSVData(results.data);
                    initializeDashboard();
                },
                error: (error) => {
                    alert(`Error al cargar los datos. Asegúrate de que '${csvFilePath}' está en la misma carpeta.`);
                    console.error("Error CSV:", error);
                }
            });
        }
        
        function processCSVData(data) {
             if (data.length > 0) {
                const firstRow = data[0];
                const requiredHeaders = ['NOMBRE', 'NÚMERO DE REGISTRO', 'MUNICIPIO', 'PUNTAJE', 'LECTURA CRÍTICA', 'MATEMÁTICAS', 'SOCIALES', 'CIENCIAS', 'INGLÉS'];
                const missingHeaders = requiredHeaders.filter(header => !firstRow.hasOwnProperty(header));
                if (missingHeaders.length > 0) {
                    alert(`Error en el archivo CSV. Faltan o no coinciden las columnas: ${missingHeaders.join(', ')}. Revisa acentos y mayúsculas.`);
                    return;
                }
            }
             const processed = data.map((row, index) => ({
                id: `${row['NÚMERO DE REGISTRO']}-${row['NOMBRE']}`, nombre: row['NOMBRE'], registro: row['NÚMERO DE REGISTRO'], municipio: row['MUNICIPIO'],
                puntajeGlobal: parseInt(row['PUNTAJE'].split('/')[0], 10) || 0,
                puntajesDetallados: { lectura: parseInt(row['LECTURA CRÍTICA'], 10) || 0, matematicas: parseInt(row['MATEMÁTICAS'], 10) || 0, sociales: parseInt(row['SOCIALES'], 10) || 0, ciencias: parseInt(row['CIENCIAS'], 10) || 0, ingles: parseInt(row['INGLÉS'], 10) || 0 }
             }));
             processed.sort((a, b) => b.puntajeGlobal - a.puntajeGlobal);
             processed.forEach((student, index) => { student.globalRank = index + 1; });
             const calculatePercentile = (arr, score) => {
                 const count = arr.length; if (count === 0) return 0;
                 let lesserOrEqual = arr.filter(s => s <= score).length;
                 return Math.round((lesserOrEqual / count) * 100);
             };
             const allGlobalScores = processed.map(s => s.puntajeGlobal);
             processed.forEach(student => { student.percentil = calculatePercentile(allGlobalScores, student.puntajeGlobal); });
             filterOptions.slice(1).forEach(opt => {
                const subjectKey = opt.subjectKey;
                const allSubjectScores = processed.map(s => s.puntajesDetallados[subjectKey]);
                processed.forEach(student => { student.puntajesDetallados[`${subjectKey}Percentil`] = calculatePercentile(allSubjectScores, student.puntajesDetallados[subjectKey]); });
             });
             studentData = processed.filter(s => s.nombre && s.puntajeGlobal > 0);
        }

        function initializeDashboard() {
            if (studentData.length === 0) {
                console.error("No hay datos de estudiantes válidos para inicializar el dashboard.");
                return;
            }
            populateFilterOptions(); calculateAndDisplayStats(); renderPodium(); renderScatterPlot();
            handleFilterSelection(filterOptions[0].key, filterOptions[0].label, false); 
            updateDisplay(); setupEventListeners();
        }
        function updateDisplay() {
            filterAndSortData();
            const totalPages = Math.ceil(state.filteredData.length / state.rowsPerPage);
            if(state.currentPage > totalPages) state.currentPage = totalPages || 1;
            renderPaginatedTable(); renderMobileList(); renderPaginationControls();
            elements.totalStudentsEl.textContent = state.filteredData.length;
        }
        function filterAndSortData() {
            const searchVal = elements.searchInput.value.toLowerCase();
            state.filteredData = studentData.filter(s => (s.nombre && s.nombre.toLowerCase().includes(searchVal)) || (s.municipio && s.municipio.toLowerCase().includes(searchVal)));
            state.filteredData.sort((a, b) => {
                const key = state.currentSort.key; let valA, valB;
                if (key.includes('.')) { const [obj, prop] = key.split('.'); valA = a[obj][prop]; valB = b[obj][prop]; } else { valA = a[key]; valB = b[key]; }
                let comparison = (typeof valA === 'string') ? valA.localeCompare(valB) : valA - valB;
                let primaryDiff = (state.currentSort.direction === 'asc') ? comparison : -comparison;
                return primaryDiff !== 0 ? primaryDiff : b.puntajeGlobal - a.puntajeGlobal;
            });
        }
        
        function showReportView(studentId) {
            const student = studentData.find(s => s.id === studentId); if (!student) return;
            const subjectCardsHtml = filterOptions.slice(1).map(subjectInfo => {
                 const subjectKey = subjectInfo.subjectKey; const score = student.puntajesDetallados[subjectKey]; const subjectSkills = skillsData[subjectKey];
                 const performanceLevels = {
                    lectura: [{min: 0, max:35}, {min:36, max:50}, {min:51, max:65}, {min:66, max:100}],
                    matematicas: [{min: 0, max:35}, {min:36, max:50}, {min:51, max:70}, {min:71, max:100}],
                    sociales: [{min: 0, max:40}, {min:41, max:55}, {min:56, max:70}, {min:71, max:100}],
                    ciencias: [{min: 0, max:40}, {min:41, max:55}, {min:56, max:70}, {min:71, max:100}],
                    ingles: [{min:0,max:36, label: 'A-'}, {min:37,max:47, label: 'A1'}, {min:48,max:58, label: 'A2'}, {min:59,max:78, label: 'B1'}, {min:79,max:100, label: 'B+'}]
                 };
                 const levels = performanceLevels[subjectKey]; let studentLevelIndex = levels.findIndex(level => score >= level.min && score <= level.max);
                 let pointerLeft = (score / 100) * 100;
                 const segmentsHtml = levels.map((level, i) => {
                    const width = (level.max - level.min + 1); const isActive = i === studentLevelIndex; const levelLabel = level.label || `${i+1}`;
                    return `<div class="level-segment ${isActive ? 'active' : ''}" style="flex-grow: ${width}" data-level="${levelLabel}" title="Nivel ${levelLabel}: ${level.min} - ${level.max} pts"></div>`;
                 }).join('');
                 let skillsHtml = '';
                 if (subjectSkills && subjectSkills.categories) {
                    skillsHtml = Object.entries(subjectSkills.categories).map(([category, skills]) => `
                        <div class="mt-4"><h4 class="font-bold text-gray-800">${category}</h4><ul class="mt-2 list-disc list-inside space-y-2 text-gray-600">${skills.map(skill => `<li>${skill}</li>`).join('')}</ul></div>`).join('');
                 }
                 const levelLabelsHtml = levels.map(level => `<div style="flex-grow: ${(level.max - level.min + 1)}" class="text-center text-xs text-gray-500 font-medium">${level.label || `Nvl ${levels.indexOf(level)+1}`}</div>`).join('');
                const gradient = `linear-gradient(to right, var(--color-${subjectKey}-start), var(--color-${subjectKey}-end))`;
                return `<div class="report-card fade-in-up" style="animation-delay: ${filterOptions.indexOf(subjectInfo) * 100}ms"><div class="report-card-header" style="background: ${gradient};"><h3 class="text-2xl font-bold">${subjectInfo.label}</h3><div class="text-right"><span class="text-5xl font-extrabold">${score}</span><span class="text-2xl font-medium opacity-80">/100</span></div></div><div class="report-card-body"><p class="text-sm font-semibold mb-2 text-gray-600">Nivel de Desempeño</p><div class="performance-bar-container"><div class="your-level-pointer" style="left: ${pointerLeft}%;"><div class="pointer-box">Tu Puntaje: ${score}</div><div class="pointer-arrow"></div></div><div class="performance-level-bar">${segmentsHtml}</div><div class="flex mt-2 px-1">${levelLabelsHtml}</div></div><div class="text-center mt-8"><button class="toggle-skills-btn bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-full inline-flex items-center gap-2 hover:bg-gray-200 transition-colors" data-target="skills-${subjectKey}"><span>Ver Habilidades Adquiridas</span><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg></button></div><div id="skills-${subjectKey}" class="skills-container bg-gray-50 p-6 rounded-lg mt-4 border">${skillsHtml}</div></div></div>`;
            }).join('');
            elements.reportView.innerHTML = `<header class="text-center md:text-left mb-8 md:flex md:items-center md:justify-between"><div><h1 class="text-3xl sm:text-4xl font-extrabold text-brand-header tracking-tight">Informe Virtual Detallado</h1><p class="mt-1 text-lg text-gray-600">${student.nombre}</p></div><button id="back-to-ranking-btn" class="mt-4 md:mt-0 bg-white border border-gray-300 text-gray-700 font-bold py-2 px-5 rounded-lg inline-flex items-center gap-2 shadow-sm hover:bg-gray-50 transition-colors"><svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.79 5.23a.75.75 0 01-.02 1.06L8.832 10l3.938 3.71a.75.75 0 11-1.04 1.08l-4.5-4.25a.75.75 0 010-1.08l4.5-4.25a.75.75 0 011.06.02z" clip-rule="evenodd" /></svg>Volver al Ranking</button></header><main>${subjectCardsHtml}</main>`;
            elements.rankingView.classList.add('leaving');
            setTimeout(() => {
                 elements.rankingView.classList.add('hidden'); elements.rankingView.classList.remove('leaving');
                 elements.reportView.classList.remove('hidden'); elements.reportView.classList.add('entering');
                 window.scrollTo(0, 0);
            }, 400);
        }
        
        function setupEventListeners() {
            // ... (el resto del código de los event listeners)
        }
        
        loadInitialData();
    });
    </script>
</body>
</html>

